#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -euo pipefail

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

AWS_CLI_URL="https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
BUILD_DIR=$1
INSTALL_DIR="/app/.awscli"
TMP_DIR=$(mktemp -d)

# Open build dir
cd $BUILD_DIR

mkdir -p custom-bin
mkdir -p .profile.d

echo "-----> Downloading AWS CLI"
curl --silent --show-error --fail -o "${TMP_DIR}/awscliv2.zip" "${AWS_CLI_URL}" |& indent
unzip -qq -d "${TMP_DIR}" "${TMP_DIR}/awscliv2.zip" |& indent

echo "-----> Installing AWS CLI"
mkdir -p "${BUILD_DIR}/.awscli"

"${TMP_DIR}/aws/install" --install-dir "${INSTALL_DIR}/aws-cli" --bin-dir "custom-bin" |& indent
/app/custom-bin/aws --version |& indent

echo "-----> Exporting PATH"

echo "export PATH=$PATH:$HOME/custom-bin" >> .profile.d/custom_binaries.sh

rm -rf "${TMP_DIR}"

echo "-----> Successfully installed AWS CLI"